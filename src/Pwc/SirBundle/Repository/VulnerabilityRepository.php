<?php

namespace Pwc\SirBundle\Repository;

use Doctrine\ORM\EntityRepository;

class VulnerabilityRepository extends EntityRepository
{
    public function findAllSorted($sortField, $sortDirection)
    {
        $query = $this->createQueryBuilder('v')
                      ->select('v')
                      ->orderBy('v.' . $sortField, $sortDirection);

        return $query->getQuery()->getResult();
    }

    public function findOneBySlugWithJoins($slug)
    {
        $query =  $this->createQueryBuilder('v')
                        ->select('v, p, t, lay, r, cl, ci, ct, cc, owr, owi, vr, vd, lan')
                        ->leftJoin('v.productRefs', 'p')
                        ->leftJoin('v.tool', 't')
                        ->innerJoin('v.layer', 'lay')
                        ->innerJoin('v.rootcause', 'r')
                        ->innerJoin('v.likelihood', 'cl')
                        ->innerJoin('v.impact', 'ci')
                        ->innerJoin('v.time', 'ct')
                        ->innerJoin('v.cost', 'cc')
                        ->leftJoin('v.owaspRefs', 'owr')
                        ->leftJoin('owr.owaspitem', 'owi')
                        ->leftJoin('v.vulnRefs', 'vr')
                        ->leftJoin('v.vulnDescriptions', 'vd')
                        ->leftJoin('vd.language', 'lan')
                        ->where('v.slug = :slug')
                        ->setParameters(array(
                            'slug' => $slug
                        ));

        return $query->getQuery()->getOneOrNullResult();
    }
}