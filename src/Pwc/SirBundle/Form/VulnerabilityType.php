<?php

namespace Pwc\SirBundle\Form;

use Symfony\Component\Form\AbstractType;
use Symfony\Component\Form\FormBuilderInterface;
use Symfony\Component\OptionsResolver\OptionsResolverInterface;

class VulnerabilityType extends AbstractType
{
    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        $builder
            ->add('name', null, array('label' => 'form.label.vulnerability.name'))
            ->add('layer', null, array('empty_value' => 'layer.empty_value', 'label' => 'form.label.vulnerability.layer'))
            ->add('rootcause', null, array('empty_value' => 'rootcause.empty_value', 'label' => 'form.label.vulnerability.rootcause'))
            ->add('likelihood', null, array('empty_value' => 'likelihood.empty_value', 'label' => 'form.label.vulnerability.likelihood'))
            ->add('impact', null, array('empty_value' => 'impact.empty_value', 'label' => 'form.label.vulnerability.impact'))
            ->add('time', null, array('empty_value' => 'time.empty_value', 'label' => 'form.label.vulnerability.time'))
            ->add('cost', null, array('empty_value' => 'cost.empty_value', 'label' => 'form.label.vulnerability.cost'))
            ->add('tool', null, array('empty_value' => 'tool.empty_value', 'label' => 'form.label.vulnerability.tool'))
            ->add('products','entity', array(
                'class'         => 'PwcSirBundle:Product',
                'label'         => 'form.label.vulnerability.products',
                'multiple'      => true,
                'required'      => false
            ))
            ->add('owaspitems','entity', array(
                'class'         => 'PwcSirBundle:OwaspItem',
                'label'         => 'form.label.vulnerability.owaspitems',
                'group_by'      => 'owaspset.name',
                'multiple'      => true,
                'required'      => false,
                'query_builder' => function(\Doctrine\ORM\EntityRepository $er) {
                    return $er->findAllRanked();
                }
            ))
            ->add('vulnRefs', 'collection', array(
                    'type'         => new VulnRefType(),
                    'label'        => 'form.label.vulnerability.vulnrefs',
                    'required'     => false,
                    'allow_add'    => true,
                    'allow_delete' => true,
                    'by_reference' => false
                ))
            ->add('services', 'collection', array(
                    'type'         => new ServiceType(),
                    'label'        => 'form.label.vulnerability.services',
                    'required'     => false,
                    'allow_add'    => true,
                    'allow_delete' => true,
                    'by_reference' => false
                ))
        ;
    }

    public function setDefaultOptions(OptionsResolverInterface $resolver)
    {
        $resolver->setDefaults(array(
            'data_class' => 'Pwc\SirBundle\Entity\Vulnerability'
        ));
    }

    public function getName()
    {
        return 'pwc_sirbundle_vulnerabilitytype';
    }
}
